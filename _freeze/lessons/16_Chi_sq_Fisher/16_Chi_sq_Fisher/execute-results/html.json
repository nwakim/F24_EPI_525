{
  "hash": "78e24b922b0e3ec50c7f251f4c2ec30e",
  "result": {
    "markdown": "---\ntitle: \"Lesson 16: Chi-squared test\"\nsubtitle: \"TB sections 8.3-8.4\"\nauthor: \"Meike Niederhausen and Nicky Wakim\"\ntitle-slide-attributes:\n    data-background-color: \"#3070BF\"\ndate: \"11/20/2024\"\nformat: \n  revealjs:\n    theme: \"../simple_NW.scss\"\n    chalkboard: true\n    slide-number: true\n    show-slide-number: all\n    width: 1955\n    height: 1100\n    footer: Lesson 16 Slides\n    html-math-method: mathjax\n    highlight-style: arrow\nexecute:\n  echo: true\n  freeze: auto\n---\n\n\n\n\n# Learning Objectives\n\n1.  Understand when to use chi-squared\n\n2.  Display data from two categorical variables, each with 2 or more categories, using R X C contingency tables\n\n3.  Determine if a nominal response and nominal explanatory variable are associated with one another using the Chi-squared test\n\n\n::: {.cell}\n<style type=\"text/css\">\n.reveal code {\n  max-height: 100% !important;\n}\n</style>\n:::\n\n\n## Where are we?\n\n![](../img_slides/course_map.png){fig-align=\"center\"}\n\n## Last time\n\n-   We looked at inference for a **single proportion**\n-   We looked at inference for a difference in **two independent proportions**\n\n \n\n-   If there are two groups, we could see if they had different proportions by testing if the difference between the proportions were the same (null) or different (alternative, two-sided, $\\neq$)\n\n \n\n-   What happens when we want to compare two **or more** groups' proportions?\n\n    -   Can no longer rely on the difference in proportions\n    -   Need a new method to make inference (Chi-squared test!)\n\n# Learning Objective\n\n## From Lesson 4: Example: hypertension prevalence (1/2)\n\n-   US CDC estimated that between 2011 and 2014[^1], 29% of the population in America had hypertension\n\n[^1]: <https://www.cdc.gov/nchs/products/databriefs/db220.htm>\n\n \n\n-   A health care practitioner seeing a new patient would expect a 29% chance that the patient might have hypertension\n    -   However, this is **only the case if nothing else is known about the patient**\n\n## From Lesson 4: Example: hypertension prevalence (2/2)\n\n-   Prevalence of **hypertension varies significantly with age**\n    -   Among adults aged 18-39, 7.3% have hypertension\n    -   Adults aged 40-59, 32.2%\n    -   Adults aged 60 or older, 64.9% have hypertension\n\n \n\n-   Knowing the age of a patient provides important information about the likelihood of hypertension\n\n    -   Age and hypertension status are **not independent** - **Can we back up this claim??**\n\n-   While the probability of hypertension of a randomly chosen adult is 0.29...\n\n    -   The **conditional probability** of hypertension in a person known to be 60 or older is 0.649\n\n \n\n::: lob\n**Question:** Is there an association between age group and hypertension?\n:::\n\n## From Lesson 4: Contingency tables\n\n-   We can start looking at the **contingency table** for hypertension for different age groups\n    -   **Contingency table:** type of data table that displays the frequency distribution of two or more categorical variables\n\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Table: Contingency table showing hypertension status and age group, in\nthousands.\n\n|Age Group | Hypertension| No Hypertension|  Total|\n|:---------|------------:|---------------:|------:|\n|18-39 yrs |         8836|          112206| 121042|\n|40-59 yrs |        42109|           88663| 130772|\n|60+ yrs   |        39917|           21589|  61506|\n|Total     |        90862|          222458| 313320|\n:::\n:::\n\n\n## Test of General Association + Hypotheses\n\n-   **General research question:** Are two variables (both categorical, nominal) associated with each other?\n\n::::::::::: columns\n:::::: column\n::::: blue\n::: blue-ttl\nGeneral wording for hypotheses\n:::\n\n::: blue-cont\nTest of \"**association**\" wording\n\n-   $H_0$: There is no association between the two variables\n\n-   $H_A$: There is an association between the two variables\n\nTest of \"**independence**\" wording\n\n-   $H_0$: The variables are independent\n\n-   $H_A$: The variables are not independent\n:::\n:::::\n::::::\n\n:::::: column\n::::: pink\n::: pink-ttl\nHypotheses test for example\n:::\n\n::: pink-cont\nTest of \"**association**\" wording\n\n-   $H_0$: There is no association between age and hypertension\n\n-   $H_A$: There is an association between age and hypertension\n\nTest of \"**independence**\" wording\n\n-   $H_0$: The variables age and hypertension are independent\n\n-   $H_A$: The variables age and hypertension are not independent\n:::\n:::::\n::::::\n:::::::::::\n\n## $H_0$: Variables are Independent (under the null)\n\n:::::: columns\n::: {.column width=\"48.5%\"}\n-   Recall from Chapter 2, that events $A$ and $B$ are independent if and only if\n\n$$P(A \\cap B)=P(A)P(B)$$\n\n-   If age and hypertension are independent variables, then *theoretically* this condition needs to hold for *every combination of levels*, i.e.\n\n\\begin{align}\nP(18-39 \\cap \\text{hyp}) &= P(18-39)P(\\text{hyp})\\\\\nP(18-39 \\cap \\text{no hyp}) &= P(18-39)P(\\text{no hyp})\\\\\nP(40-59 \\cap \\text{hyp}) &= P(40-59)P(\\text{hyp})\\\\\nP(40-59 \\cap \\text{no hyp}) &= P(40-59)P(\\text{no hyp})\\\\\nP(60+ \\cap \\text{hyp}) &= P(60+)P(\\text{hyp})\\\\\nP(60+ \\cap \\text{no hyp}) &= P(60+)P(\\text{no hyp})\\\\\n\\end{align}\n:::\n\n::: {.column width=\"2%\"}\n:::\n\n::: {.column width=\"38.5%\"}\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"font-size: 28px; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Age Group </th>\n   <th style=\"text-align:right;\"> Hypertension </th>\n   <th style=\"text-align:right;\"> No Hypertension </th>\n   <th style=\"text-align:right;\"> Total </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 18-39 yrs </td>\n   <td style=\"text-align:right;\"> 8836 </td>\n   <td style=\"text-align:right;\"> 112206 </td>\n   <td style=\"text-align:right;\"> 121042 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 40-59 yrs </td>\n   <td style=\"text-align:right;\"> 42109 </td>\n   <td style=\"text-align:right;\"> 88663 </td>\n   <td style=\"text-align:right;\"> 130772 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 60+ yrs </td>\n   <td style=\"text-align:right;\"> 39917 </td>\n   <td style=\"text-align:right;\"> 21589 </td>\n   <td style=\"text-align:right;\"> 61506 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Total </td>\n   <td style=\"text-align:right;\"> 90862 </td>\n   <td style=\"text-align:right;\"> 222458 </td>\n   <td style=\"text-align:right;\"> 313320 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\\begin{align}\nP(18-39 \\cap \\text{hyp}) &= \\frac{121042}{313320}\\cdot\\frac{90862}{313320}\\\\\n & ...\\\\\nP(60+ \\cap \\text{no hyp}) &=\\frac{61506}{313320}\\cdot\\frac{222458}{313320}\n\\end{align}\n\nWith these probabilities, for each cell of the table we calculate the **expected** counts for each cell under the $H_0$ hypothesis that the variables are independent\n:::\n::::::\n\n## Expected counts (if variables are independent)\n\n::::: columns\n::: {.column width=\"60%\"}\n-   The expected counts (if $H_0$ is true & the variables are independent) for each cell are\n    -   $np = \\text{total table size} \\cdot \\text{probability of cell}$\n    -   $\\text{expected count} = \\dfrac{\\text{column total}\\cdot \\text{row total}}{\\text{table total}}$\n\nExpected count of 40-59 years old and hypertension:\n\n\\begin{align}\n\\text{expected count} &= \\dfrac{\\text{column total}\\cdot \\text{row total}}{\\text{table total}} \\\\\n&= \\dfrac{\\text{90862}\\cdot \\text{130772}}{\\text{313320}} \\\\ \n&= 37923.55\n\\end{align}\n:::\n\n::: {.column width=\"40%\"}\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"font-size: 28px; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Age Group </th>\n   <th style=\"text-align:right;\"> Hypertension </th>\n   <th style=\"text-align:right;\"> No Hypertension </th>\n   <th style=\"text-align:right;\"> Total </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 18-39 yrs </td>\n   <td style=\"text-align:right;\"> 8836 </td>\n   <td style=\"text-align:right;\"> 112206 </td>\n   <td style=\"text-align:right;\"> 121042 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 40-59 yrs </td>\n   <td style=\"text-align:right;\"> 42109 </td>\n   <td style=\"text-align:right;\"> 88663 </td>\n   <td style=\"text-align:right;\"> 130772 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 60+ yrs </td>\n   <td style=\"text-align:right;\"> 39917 </td>\n   <td style=\"text-align:right;\"> 21589 </td>\n   <td style=\"text-align:right;\"> 61506 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Total </td>\n   <td style=\"text-align:right;\"> 90862 </td>\n   <td style=\"text-align:right;\"> 222458 </td>\n   <td style=\"text-align:right;\"> 313320 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n \n\n-   If age group and hypertension are **independent** variables\n    -   (as assumed by $H_0$),\n-   then the **observed counts should be close to the expected counts** for each cell of the table\n:::\n:::::\n\n-   Test to see how likely is it that we observe our data given the null hypothesis (no association)\n\n## Observed vs. Expected counts\n\n::::: columns\n::: {.column width=\"50%\"}\n-   The **observed** counts are the counts in the 2-way table summarizing the data\n\n \n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"font-size: 40px; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Age Group </th>\n   <th style=\"text-align:right;\"> Hypertension </th>\n   <th style=\"text-align:right;\"> No Hypertension </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 18-39 yrs </td>\n   <td style=\"text-align:right;\"> 8836 </td>\n   <td style=\"text-align:right;\"> 112206 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 40-59 yrs </td>\n   <td style=\"text-align:right;\"> 42109 </td>\n   <td style=\"text-align:right;\"> 88663 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 60+ yrs </td>\n   <td style=\"text-align:right;\"> 39917 </td>\n   <td style=\"text-align:right;\"> 21589 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n:::\n\n::: {.column width=\"50%\"}\n-   The **expected** counts are the counts the we would expect to see in the 2-way table if there was no association between age group and hypertension\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"font-size: 40px; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Age Group </th>\n   <th style=\"text-align:right;\"> Hypertension </th>\n   <th style=\"text-align:right;\"> No Hypertension </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 18-39 yrs </td>\n   <td style=\"text-align:right;\"> 35101.87 </td>\n   <td style=\"text-align:right;\"> 85940.13 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 40-59 yrs </td>\n   <td style=\"text-align:right;\"> 37923.55 </td>\n   <td style=\"text-align:right;\"> 92848.45 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 60+ yrs </td>\n   <td style=\"text-align:right;\"> 17836.58 </td>\n   <td style=\"text-align:right;\"> 43669.42 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n:::\n:::::\n\n \n\nExpected count for cell $i,j$ :\n\n$$\\textrm{Expected Count}_{\\textrm{row } i,\\textrm{ col }j}=\\frac{(\\textrm{row}~i~ \\textrm{total})\\cdot(\\textrm{column}~j~ \\textrm{total})}{\\textrm{table total}}$$\n\n## Using R for expected cell counts\n\n-   R calculates expected cell counts using the `expected()` function in the `epitools` package\n\n-   Make sure dataset is in `matrix` form using `as.matrix()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhyp_data2\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          Hypertension No_Hypertension\n18-39 yrs         8836          112206\n40-59 yrs        42109           88663\n60+ yrs          39917           21589\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(epitools)\nexpected(hyp_data2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          Hypertension No_Hypertension\n18-39 yrs     35101.87        85940.13\n40-59 yrs     37923.55        92848.45\n60+ yrs       17836.58        43669.42\n```\n:::\n:::\n\n\n# Learning Objectives\n\n\n## Reference: Steps in a Hypothesis Test\n\n1.  Check the [**assumptions**]{style=\"color:#3070BF\"}\n\n2.  Set the [**level of significance**]{style=\"color:#3070BF\"} $\\alpha$\n\n3.  Specify the [**null**]{style=\"color:#3070BF\"} ( $H_0$ ) and [**alternative**]{style=\"color:#3070BF\"} ( $H_A$ ) [**hypotheses**]{style=\"color:#3070BF\"}\n\n    1.  ~~In symbols~~\n    2.  In words\n    3.  ~~Alternative: one- or two-sided?~~\n\n4.  Calculate the [**test statistic**]{style=\"color:#3070BF\"}.\n\n5.  Calculate the [**p-value**]{style=\"color:#3070BF\"} based on the observed test statistic and its sampling distribution\n\n6.  Write a [**conclusion**]{style=\"color:#3070BF\"} to the hypothesis test\n\n    1.  Do we reject or fail to reject $H_0$?\n    2.  Write a conclusion in the context of the problem\n\n## Step 1: Check assumptions\n\n-   **Independence**\n    -   All individuals are independent from one another\n        -   In particular, observational units cannot be represented in more than one cell\n        -   For example, someone cannot be in two differnt age groups\n\n::::: columns\n::: {.column width=\"55%\"}\n-   **Sample size**\n    -   In order for the distribution of the test statistic to be appropriately modeled by a chi-squared distribution we need\n    -   [2 $\\times$ 2 table]{style=\"color:#367B79\"}\n        -   expected counts are at least 10 for each cell\n    -   [Larger tables]{style=\"color:#367B79\"}\n        -   No more than 20% of expected counts are less than 5\n        -   All expected counts are greater than 1\n:::\n\n\n::: {.column width=\"45%\"}\n\n \n\n \n\n \n\n\n::: {.cell}\n\n```{.r .cell-code}\nexpected(hyp_data2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          Hypertension No_Hypertension\n18-39 yrs     35101.87        85940.13\n40-59 yrs     37923.55        92848.45\n60+ yrs       17836.58        43669.42\n```\n:::\n:::\n\n\nAll expected counts \\> 5\n:::\n:::::\n\n## Step 2 and 3: Significance level and Hypotheses\n\n- Set $\\alpha = 0.05$\n\n \n\n::::: pink\n::: pink-ttl\nHypotheses test for example\n:::\n\n::: pink-cont\nTest of \"**association**\" wording\n\n-   $H_0$: There is no association between age and hypertension\n\n-   $H_A$: There is an association between age and hypertension\n\nTest of \"**independence**\" wording\n\n-   $H_0$: The variables age and hypertension are independent\n\n-   $H_A$: The variables age and hypertension are not independent\n:::\n:::::\n\n## Step 4: Calculate the $\\chi^2$ test statistic\n\n::::: columns\n::: {.column width=\"45%\"}\nTest statistic for a test of association (independence):\n\n$$\\chi^2 = \\sum_{\\textrm{all cells}} \\frac{(\\textrm{observed} - \\text{expected})^2}{\\text{expected}}$$\n\n-   When the variables are independent, the observed and expected counts should be close to each other\n:::\n\n::: {.column width=\"55%\"}\n![](/img_slides/ChiSq_Table_Expected_brief_DepressionPA.png){fig-align=\"center\"}\n:::\n:::::\n\n<hr>\n\n::: {style=\"font-size: 90%;\"}\n\\begin{align}\n\\chi^2 &=  \\sum\\frac{(O-E)^2}{E} \\\\\n&= \\frac{(199-177.41)^2}{177.41} + \\frac{(26-32.77)^2}{32.77} + \\ldots + \\frac{(27-12.18)^2}{12.18} \\\\\n&=  41.2\n\\end{align}\n:::\n\nIs this value big? Big enough to reject $H_0$?\n\n## Step 5: Calculate the *p*-value\n\n::::: columns\n::: {.column width=\"60%\"}\nThe $\\chi^2$ distribution shape depends on its degrees of freedom\n\n-   It's skewed right for smaller df,\n    -   gets more symmetric for larger df\n-   [**df = (# rows-1) x (# columns-1)**]{style=\"color:green\"}\n\n![](/img_slides/chisq_density.png){fig-align=\"center\"}\n:::\n\n::: {.column width=\"40%\"}\n-   The [**p-value**]{style=\"color:darkorange\"} is always the [**area to the right**]{style=\"color:darkorange\"} of the test statistic for a $\\chi^2$ test.\n-   We can use the `pchisq` function in R to calculate the probability of being at least as big as the $\\chi^2$ test statistic:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npv <- pchisq(41.2, df = 2, \n       lower.tail = FALSE)\npv\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1.131185e-09\n```\n:::\n:::\n\n\nWhat's the conclusion to the $\\chi^2$ test?\n:::\n:::::\n\n## Step 6: Conclusion\n\nRecall the hypotheses to our $\\chi^2$ test:\n\n-   $H_0$: There is **no association** between depression and being physically activity\n\n-   $H_A$: There is **an association** between depression and being physically activity\n\n::::: columns\n::: {.column width=\"50%\"}\n\n::: {.cell}\n::: {.cell-output-display}\n![](16_Chi_sq_Fisher_files/figure-revealjs/unnamed-chunk-12-1.png){width=768}\n:::\n:::\n\n:::\n\n::: {.column width=\"50%\"}\n**Conclusion:**\n\nBased a random sample of 400 US adults from 2009-2012, there is sufficient evidence that there is an association between depression and being physically activity (*p*-value \\< 0.001).\n:::\n:::::\n\n::: callout-warning\nIf we fail to reject, we DO NOT have evidence of no association.\n:::\n\n## Chi-squared test: Example\n\n::::: columns\n::: column\n1.  Check expected cell counts threshold\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexpected(hyp_data2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          Hypertension No_Hypertension\n18-39 yrs     35101.87        85940.13\n40-59 yrs     37923.55        92848.45\n60+ yrs       17836.58        43669.42\n```\n:::\n:::\n\n\nAll expected cells are greater than 5.\n\n2.  $\\alpha = 0.05$\n\n3.  Hypothesis test:\n\n    -   $H_0$ : There is no association between age group and hypertension\n    -   $H_1$ : There is an association between age group and hypertension\n:::\n\n::: column\n4-5.  Calculate the test statistic and p-value for Chi-squared test in R\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchisq.test(x = hyp_data2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's Chi-squared test\n\ndata:  hyp_data2\nX-squared = 66831, df = 2, p-value < 2.2e-16\n```\n:::\n:::\n\n\n6.  Conclusion\n\nWe reject the null hypothesis that age group and hypertension are not associated ($p<2.2\\cdot10^{-16}$). There is sufficient evidence that age group and hypertension are associated.\n:::\n:::::\n",
    "supporting": [
      "16_Chi_sq_Fisher_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}